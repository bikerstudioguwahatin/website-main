// Enhanced Prisma Schema with Menu Structure Support
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Nullable for OAuth users
  phone         String?
  role          UserRole  @default(USER)
  image         String?
  emailVerified DateTime? // Changed to DateTime for NextAuth compatibility
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  addresses     Address[]
  orders        Order[]
  cart          CartItem[]
  reviews       Review[]
  accounts      Account[]
  sessions      Session[]

  @@index([email])
}

// NextAuth OAuth Support
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName  String
  phone     String
  street    String
  city      String
  state     String
  pincode   String
  country   String   @default("India")
  isDefault Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]

  @@index([userId])
}

// ============================================
// MENU STRUCTURE (NEW - For Dynamic Mega Menu)
// ============================================

enum MenuType {
  BRAND_MENU          // Shop by Bike
  CATEGORY_MENU       // Motorcycle Accessories, Riding Gears, etc.
  CUSTOM_MENU         // Custom menu items
}

model MenuItem {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  type        MenuType
  description String?
  icon        String?  // Icon name or URL
  image       String?  // Background image for mega menu
  isActive    Boolean  @default(true)
  position    Int      @default(0)
  
  // Parent-child relationship for hierarchical menus
  parentId    String?
  parent      MenuItem?  @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    MenuItem[] @relation("MenuHierarchy")
  
  // Relations to actual content
  brandId     String?
  brand       Brand?     @relation(fields: [brandId], references: [id], onDelete: SetNull)
  
  categoryId  String?
  category    Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([type])
  @@index([parentId])
  @@index([position])
  @@index([isActive])
}

// ============================================
// PRODUCT CATALOG
// ============================================

// Bike Brands (Kawasaki, KTM, Yamaha, etc.)
model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  logo        String
  bgColor     String   @default("bg-white")
  textColor   String   @default("text-gray-800")
  description String?
  isActive    Boolean  @default(true)
  position    Int      @default(0) // For menu ordering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bikes       Bike[]
  menuItems   MenuItem[]

  @@index([slug])
  @@index([position])
}

// Individual Bike Models (Ninja 400, Duke 390, etc.)
model Bike {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  model       String
  year        Int
  description String?
  image       String
  isActive    Boolean  @default(true)
  position    Int      @default(0) // For menu ordering

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products   Product[]
  categories Category[]

  @@index([slug])
  @@index([brandId])
  @@index([position])
}

// Product Categories (can be bike-specific OR general)
// Examples: "Helmets", "Crash Guards", "Engine Oil", "Riding Gear"
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  image       String?
  icon        String?  // Icon for menu display
  isActive    Boolean  @default(true)
  position    Int      @default(0) // For menu ordering
  
  // Menu display settings
  showInMenu    Boolean @default(true)
  menuColumns   Int     @default(1) // How many columns in mega menu

  // If bike-specific, this will be set
  // If general (like helmets, gears), this is NULL
  bikeId String?
  bike   Bike?   @relation(fields: [bikeId], references: [id], onDelete: SetNull)

  // Parent category for hierarchical structure
  // Example: "Helmets" -> "Full Face Helmets"
  parentId String?
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("SubCategories")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products  Product[]
  menuItems MenuItem[]

  @@index([slug])
  @@index([bikeId])
  @@index([parentId])
  @@index([position])
  @@index([showInMenu])
}

// Products (Universal - can be bike-specific OR general)
model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String
  price       Decimal  @db.Decimal(10, 2)
  salePrice   Decimal? @db.Decimal(10, 2)
  stock       Int      @default(0)
  sku         String   @unique

  // Images - Now with Cloudinary support
  images    String[] // Array of Cloudinary URLs
  thumbnail String   // Cloudinary URL

  // SEO
  metaTitle       String?
  metaDescription String?

  // Product Details
  weight     Decimal? @db.Decimal(10, 2)
  dimensions String?  // JSON string for L x W x H
  material   String?
  color      String?
  size       String?

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Category
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  // If product is bike-specific (like "Ninja 400 Crash Guard")
  // If NULL, it's a general product (like "Full Face Helmet")
  bikeId String?
  bike   Bike?   @relation(fields: [bikeId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       Review[]

  @@index([slug])
  @@index([categoryId])
  @@index([bikeId])
  @@index([sku])
}

// ============================================
// SHOPPING CART
// ============================================

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity  Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

// ============================================
// ORDERS & PAYMENTS
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  UPI
  NET_BANKING
  COD
  WALLET
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Shipping Address
  addressId String
  address   Address @relation(fields: [addressId], references: [id], onDelete: Restrict)

  // Order Details
  status       OrderStatus @default(PENDING)
  subtotal     Decimal     @db.Decimal(10, 2)
  tax          Decimal     @db.Decimal(10, 2)
  shippingCost Decimal     @db.Decimal(10, 2)
  discount     Decimal     @default(0) @db.Decimal(10, 2)
  total        Decimal     @db.Decimal(10, 2)

  // Payment
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod PaymentMethod
  paymentId     String?       // Transaction ID from payment gateway

  // Tracking
  trackingNumber String?
  courierService String?

  // Notes
  customerNotes String?
  adminNotes    String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deliveredAt DateTime?

  // Relations
  items OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  quantity Int
  price    Decimal @db.Decimal(10, 2) // Price at time of order
  subtotal Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  rating  Int      // 1-5
  title   String?
  comment String
  images  String[] // Array of image URLs

  isVerifiedPurchase Boolean @default(false)
  isApproved         Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
}

// ============================================
// ADMIN SETTINGS
// ============================================

model SiteSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   // JSON string for complex values
  description String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// Coupon/Discount Codes
model Coupon {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  discountType  String  // "PERCENTAGE" or "FIXED"
  discountValue Decimal @db.Decimal(10, 2)

  minOrderValue Decimal? @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)

  usageLimit Int?
  usageCount Int     @default(0)

  isActive Boolean @default(true)

  validFrom  DateTime
  validUntil DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

// Banner/Slider Management
model Banner {
  id          String  @id @default(cuid())
  title       String
  subtitle    String?
  image       String  // Cloudinary URL
  mobileImage String? // Cloudinary URL for mobile
  link        String?

  position Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([position])
  @@index([isActive])
}

// ============================================
// BULK IMPORT TRACKING (NEW)
// ============================================

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ImportType {
  BRANDS
  BIKES
  CATEGORIES
  PRODUCTS
  MENU_ITEMS
}

model BulkImport {
  id          String       @id @default(cuid())
  type        ImportType
  status      ImportStatus @default(PENDING)
  fileName    String
  fileUrl     String       // URL to uploaded Excel file
  totalRows   Int
  successRows Int          @default(0)
  failedRows  Int          @default(0)
  errors      String?      @db.Text // JSON string of errors
  
  createdBy   String       // User ID who initiated import
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  completedAt DateTime?

  @@index([status])
  @@index([type])
  @@index([createdAt])
}
